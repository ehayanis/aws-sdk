<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.11.1 (455059)"/><meta name="altitude" content="49"/><meta name="author" content="hayani.mehdi149@gmail.com"/><meta name="created" content="2017-11-18 11:31:09 +0000"/><meta name="latitude" content="48.86033670199634"/><meta name="longitude" content="2.351589593611866"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-11-18 11:56:33 +0000"/><title>VPC LAB</title></head><body><div><span style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">Create a VPC</span></div><div><ul><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">10.0.0.0/16 range </span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">By default it creates a route table, a security group and a Network ACL</span></li></ul><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Create Two subnets </span></div><div><ul><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">10.0.1.0/24</span> ::: <span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">"subnet actions": Enable auto-assign public IP (Possible to do it while create an EC instance) </span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">10.0.2.0/24</span></li></ul><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Create a Internet Gateway and attach it to the VPC</span></div><div><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Add a route tables</span></div><div><ul><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Add route out to IG: Traffic from 0.0.0.0:0 to the IG </span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Add subnet associations</span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Main default route table should not have access to IG, because every subnet when created is associated by default to this </span></li></ul><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">route table </span></div><div><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Create EC2 Instances </span></div><div><ul><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">When creation selection VPC and subnet </span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Allow port 80 and 22</span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">Add bootstrap script <br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">  #!/bin/bash <br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">  yum install httpd -y<br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">  yum update -y <br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">  service httpd start <br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">  chkconfig httpd on <br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">  echo "&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;" &gt; /var/www/html/index.html</span></li><li><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">For the second instance, add a specific security groups with open PYSQL and SSH PORT to only 10.0.1.0/24 <br/></span><span style="color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-size: 13px; white-space: pre-wrap;">and an "ALL-ICMP" traffic which allows to ping this instance from the public Subnet </span></li></ul></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">Login to public instance, ssh ec2-user@IP_ADDRESS -i privatekey </div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><ul><li>Then "sudo su"</li><li>ping private ip </li><li>Copy private key to public instance and test ssh (chmod 0600 privatekey) </li></ul></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">Add NAT Instance</div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><ul><li>Create and EC2 </li><li>Go to "Community AMIs"and look for "nat" </li><li>Select VPC and select first subnet </li><li>Reuse public EC2 instance security Group </li><li>Once EC2 started, go to "Actions" &gt; "Networking" &gt; Disable "Change source/Dest check" </li><li>Add HTTPS to security groups </li><li>Add route out to the Internet from private NAT instance to "IG" </li><li>Select default "route table" and add toute from "0.0.0.0/0 to "NAT Instance" </li></ul>Add NAT Gateway (preferred for production, scale automatically and Amazon handle it)  </div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><ul><li>Create a NAT Gateway </li><li>Select public subnet</li><li>Go to the main route table and add a route </li><li>From 0.0.0.0/0 to "NAT GATEWAY" </li></ul>Create Nework ACL</div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><ul><li>Go to "Subnet Associations" and add public subnet </li><li>Add inbound and outbound rules HTTP, HTTPS, SSH, RDP </li><li>May not work at the beginning, because of Ephemeral ports::: Add "custom TCP Ports" with port range "1024-65535"</li><li>Test to DENY MY IP address </li></ul><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div>Create Flow Logs: <br/><ul><li>Select your VPC then "Actions" &gt; "Create Flow Logs”</li><li>Before, go to CloudWatch and Create a "Log Group" with a "Log Stream" inside and need to Create also a new IAM Role </li></ul></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">Bastion: EC2 instance allows to securily administer (SSH) your private subnet fleet <br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div style="box-sizing: border-box; padding: 0px; border: 0px; outline: 0px; font-size: 13px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; color: rgb(51, 51, 51); font-family: Helvetica, Arial, sans-serif; font-variant-caps: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: pre-wrap; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><br/></div><div><br/></div></body></html>